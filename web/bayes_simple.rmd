---
title: "Simple Bayes"
output:
  html_document:
    code_folding: hide
---

```{r setup, child = 'web/_include/setup.rmd'}
```

I'm sorry, right now different versions of these functions live in different notebooks. If they look like they are going to have a longer lifespan, I will work on integrating them into a single function. 

```{r}
eb_boot <- function(beta, p = 60, b = 2, n = 100, niter = 100, plot = TRUE) {
  
  dat <- genDataABN(beta = beta, p = p, a = length(beta), b = b, n = n)
  
  tbeta <- dat$beta
  X <- dat$X
  y <- dat$y
  
  lowers <- matrix(nrow = niter, ncol = length(tbeta))
  uppers <- matrix(nrow = niter, ncol = length(tbeta))

  for (i in 1:niter) {

    idx_new <- sample(1:length(y), replace = TRUE)
    ynew <- y[idx_new]
    xnew <- X[idx_new,,drop=FALSE]
    
    cv_res <- cv.ncvreg(xnew, ynew, penalty = "lasso")
    sigma2 <- cv_res$cve[cv_res$lambda == cv_res$lambda.min]
    lam <- cv_res$lambda.min
    coefs <- coef(cv_res$fit, lambda = lam)
    rate <- (lam*n / sigma2)
    
    ## Beta specific
    for (j in 1:length(tbeta)) {
      
      r <- ynew - (coefs[1] + xnew[,-j,drop=FALSE] %*% coefs[-1][-j])
      post_mode <- coefs[-1][j]
      
      # HPD attempt
      # p <- 0.8
      # bounds <- find_narrowest_interval(p, rate = rate, partial_residuals = r, sigma = sqrt(sigma2), xvar = xnew[,j,drop=FALSE])
      # lowers[i,j] <- bounds[1]
      # uppers[i,j] <- bounds[2]
      
      ## Need to compress this into a single call in future
      uppers[i,j] <- post_quant(.9, post_mode, sqrt(sigma2), rate, xnew[,j,drop=FALSE], r, plot = plot)
      lowers[i,j] <- post_quant(.1, post_mode, sqrt(sigma2), rate, xnew[,j,drop=FALSE], r, plot = FALSE)
      
      
    }
    
  }
  
  return(list("lower" = lowers, "upper" = uppers, "truth" = tbeta))
  
}
```


# One Covariate

## Beta = 0

### One Example

```{r}
tmp <- eb_boot(beta = 0, p = 1, b = 0, n = 30, niter = 10)
print(c(mean(tmp$lower), mean(tmp$upper)))
print(c(median(tmp$lower), median(tmp$upper)))
```



### Coverage

```{r, eval=FALSE}
set.seed(1234)
res <- eb_boot_sim(beta = 0, p = 1, b = 0, n = 30, niter = 100, nboot = 100)
save(res, file = "/Users/loganharris/github/lasso-boot/web/data/beta0_cov_simple.rds")
mean(res$overall_cov)
```

```{r, echo=FALSE}
load("/Users/loganharris/github/lasso-boot/web/data/beta0_cov_simple.rds")
mean(res$overall_cov)
```

## Beta = 3

```{r, eval = FALSE}
beta3 <- eb_boot(beta = 3, p = 1, b = 0, n = 30, niter = 10)

c(mean(beta3$lower), mean(beta3$upper))
c(median(beta3$lower), median(beta3$upper))
```


```{r, eval = FALSE}
set.seed(1234)
res <- eb_boot_sim(beta = 3, p = 1, b = 0, n = 30, niter = 100, nboot = 100)
save(res, file = "/Users/loganharris/github/lasso-boot/web/data/beta3_cov_simple.rds")
mean(res$overall_cov)
```

```{r, echo=FALSE}
load("/Users/loganharris/github/lasso-boot/web/data/beta3_cov_simple.rds")
mean(res$overall_cov)
```


# Many Covariates

## Not High Dimensional

### Single Example

```{r, eval = FALSE}
tmp <- eb_boot(beta = c(2, 1, 0.5, -2, -1, -0.5), plot = FALSE)
save(tmp, file = "/Users/loganharris/github/lasso-boot/web/data/many_single_simple.rds")
```

```{r}
load("/Users/loganharris/github/lasso-boot/web/data/many_single_simple.rds")
plot_boot(tmp)
```


### Coverage

```{r, eval = FALSE}
set.seed(1234)
res <- eb_boot_sim(beta = c(2, 1, 0.5, -2, -1, -0.5))
save(res, file = "/Users/loganharris/github/lasso-boot/web/data/many_simple.rds")
```

```{r, echo=FALSE}
load("/Users/loganharris/github/lasso-boot/web/data/many_simple.rds")
```

#### Overall Coverage (per bootstrap)

```{r}
mean(res$overall_cov)
hist(res$overall_cov)
```

#### Individual Coverage (per covariate)

```{r}
tmp <- data.frame(coverage = apply(res$indiv_cov, 2, mean) , beta = res$truth)
plot(abs(tmp$beta), tmp$coverage)
```
